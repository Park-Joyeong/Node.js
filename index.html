<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>This is my node server.</title>
</head>

<body>
  <h1>You are <span id="user-name" style="font-size: larger; color:blueviolet;"></span> !</h1>
  <div id="chatBox" style="width:70vw; height:50vh; overflow: auto; border-style: dotted;">

  </div>
  <form style="width:70vw; margin-top: 10px;">
    <fieldset>
      <select id="socketID" name="socketID">
      </select>
      <input type="text" id="message" name="message" size="40">
      <input type="submit" value="Send">
    </fieldset>
  </form>

  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
  <script>
    var socket = io();
    var myUserId;
    var mySocketId;
    var clients = {};

    socket.on('forMe', function (obj) {
      myUserId = obj['userId'];
      mySocketId = obj['socketId'];
      clients = obj['clients'];

      $('#user-name').html(myUserId);

      $('#socketID').append('<option value="">Everyone</option>');

      for (var eachSocketID in clients) {
        var eachUserID = clients[eachSocketID];
        if (eachSocketID === mySocketId) {
          continue;
        }
        $('#socketID').append(
          '<option value="'
          + eachSocketID + '">'
          + eachUserID
          + '</option>'
        );
      }
    });// End of socket.on(forMe)


    socket.on('new', function (obj) {
      var {
        userId,
        socketId,
        connectStatus,
      } = obj;

      if (socketId === mySocketId) {//Don't need noti to myself "I'm coming"
        return;
      }

      if (connectStatus === 'connected') {
        
        clients[socketId] = userId;
        $('#socketID').append('<option value="' + socketId + '">' + userId + '</option>');
        $('#chatBox').append("<p style='color:orange;'>※" + userId + ' is here.' + "</p>");
        $('#chatBox').scrollTop($('#chatBox').prop("scrollHeight"));

      } else if (connectStatus === 'disconnected') {
        
        delete clients[socketId];
        $('#socketID > option[value=' + socketId + ']').remove();
        $('#chatBox').append("<p style='color:orange;'>※" + userId + ' is gone.' + "</p>");
        $('#chatBox').scrollTop($('#chatBox').prop("scrollHeight"));
        

      }

    });

    $('form').submit(function (e) {
      e.preventDefault();
      var socketID = $('#socketID').val();
      var message = $('#message').val();

      var strObj = '{ "socketID": "' + socketID + '" }';
      var json_data = JSON.parse("{}");
      json_data.socketID = socketID;
      json_data.message = message;
      socket.emit('sendMessage', json_data);
      $('#message').val('');

      //Case Direct Message
      if (socketID !== '') {//Not to everyone
        $('#chatBox').append("<p style='color:green;'>Me&nbsp;&gt;&nbsp;" + clients[socketID] + ':&nbsp;' + message + "</p>");
        $('#chatBox').scrollTop($('#chatBox').prop("scrollHeight"));
      }
    });



    socket.on('receiveMessage', function (rtnObj) {
      var {
        senderSocketID,
        targetSocketID,
        message
      } = rtnObj;
      var senderUserId = clients[senderSocketID];


      if (targetSocketID === '') {//for everyone
        if (senderSocketID === mySocketId) {//My comment
          $('#chatBox').append("<p style='color:red;'>Me" + ':&nbsp;' + message + "</p>");
          $('#chatBox').scrollTop($('#chatBox').prop("scrollHeight"));
        } else {//Others comment
          $('#chatBox').append("<p>" + senderUserId + ':&nbsp;' + message + "</p>");
          $('#chatBox').scrollTop($('#chatBox').prop("scrollHeight"));
        }

      } else {//DM received
        $('#chatBox').append("<p style='color:green;'>" + senderUserId + "&nbsp;&gt;&nbsp;Me" + ':&nbsp;' + message + "</p>");
        $('#chatBox').scrollTop($('#chatBox').prop("scrollHeight"));
      }
    });



  </script>
</body>

</html>