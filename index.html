<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Cool & Fancy Chatting Room</title>
  <link rel="stylesheet" href="/index.css">
</head>

<body>
  <h1>You are <span id="user-name"></span> !</h1>
  <div id="chat-box">

  </div>
  <form id="form">
    <select id="targetSocketID" name="targetSocketID">
      <option value="">Everyone</option>
    </select>
    <input type="text" id="message" name="message" size="40">
    <input type="submit" value="Send">
  </form>
  <input type="file" id="file" name="file" onchange="changeProfilePhoto();">



  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
  <script>
    var socket = io();
    var myUserName;
    var mySocketId;

    socket.on('forMe', function (obj) {
      myUserName = obj['myUserName'];
      mySocketId = obj['mySocketId'];
      const clients = obj['clients'];
      $('#user-name').html(myUserName);

      clients.filter(obj => obj.socketId !== mySocketId).forEach(function (obj) {
        let { socketId, userName } = obj;

        $('#targetSocketID').append(
          '<option value="'
          + socketId + '">'
          + userName
          + '</option>'
        );
      });

    });// End of socket.on(forMe)


    socket.on('new', function (obj) {
      const {
        newSocketId,
        newUserName,
        connectStatus
      } = obj;


      if (connectStatus === 'connected') {

        $('#targetSocketID').append('<option value="' + newSocketId + '">' + newUserName + '</option>');
        printMSG('connected', obj);

      } else if (connectStatus === 'disconnected') {

        $('#targetSocketID > option[value=' + newSocketId + ']').remove();
        printMSG('disconnected', obj);

      }

    });

    $('form').submit(function (e) {
      e.preventDefault();
      var targetSocketID = $('#targetSocketID').val();
      var message = $('#message').val();

      var json_data = JSON.parse("{}");
      json_data.targetSocketID = targetSocketID;
      json_data.message = message;
      socket.emit('sendMessage', json_data);
      $('#message').val('');

      //Case Direct Message
      if (targetSocketID !== '') {//Not to everyone
        $('#chat-box').append("<p style='color:green;'>Me&nbsp;&gt;&nbsp;" + clients[socketID] + ':&nbsp;' + message + "</p>");
        $('#chat-box').scrollTop($('#chat-box').prop("scrollHeight"));
      }
    });



    socket.on('receiveMessage', function (rtnObj) {
      var {
        senderSocketID,
        targetSocketID,
        message
      } = rtnObj;
      var senderUserId = clients[senderSocketID];


      if (targetSocketID === '') {//for everyone
        if (senderSocketID === mySocketId) {//My comment
          $('#chat-box').append("<p style='color:red;'>Me" + ':&nbsp;' + message + "</p>");
          $('#chat-box').scrollTop($('#chat-box').prop("scrollHeight"));
        } else {//Others comment
          $('#chat-box').append("<p>" + senderUserId + ':&nbsp;' + message + "</p>");
          $('#chat-box').scrollTop($('#chat-box').prop("scrollHeight"));
        }

      } else {//DM received
        $('#chat-box').append("<p style='color:green;'>" + senderUserId + "&nbsp;&gt;&nbsp;Me" + ':&nbsp;' + message + "</p>");
        $('#chat-box').scrollTop($('#chat-box').prop("scrollHeight"));
      }
    });

    function printMSG(state, obj) {
      const {
        newSocketId,
        newUserName,
      } = obj;
      let msg = "";
      let type; // 0=sys, 1=dm
      if (state === 'connected') {
        type='sys';
        msg = newUserName + " is here.";
      } else if (state === 'disconnected') {
        type='sys';
        msg = newUserName + " is gone.";
      }
      if(type==='sys') {
        $('#chat-box').append("<p class='sysMSG'>â€»" + msg +"</p>");
      }

      

      
      $('#chat-box').scrollTop($('#chat-box').prop("scrollHeight"));
    }

    function addBtnClick() {
      document.getElementById("file").click();
    }

    function changeProfilePhoto() {

    }

  </script>
</body>

</html>